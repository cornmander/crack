# Copyright 2003 Michael A. Muller
# Portions Copyright 2009 Google Inc.

# include macros from the m4 dir.
ACLOCAL_AMFLAGS = -I m4 --install

lib_LTLIBRARIES = libCrackLang.la libCrackNativeRuntime.la
libCrackLang_la_SOURCES = %libCrackSources%
libCrackLang_la_CPPFLAGS = $(AM_CPPFLAGS) @CWD_CPPFLAGS@
libCrackLang_la_LDFLAGS = -version-info 2:0:0 @CWD_LIBS@ @LLVM_LDFLAGS@ @LLVM_LIBS@

libCrackNativeRuntime_la_SOURCES = ext/Stub.cc debug/NativeDebugTools.cc
libCrackNativeRuntime_la_CPPFLAGS = $(AM_CPPFLAGS) @CWD_CPPFLAGS@
libCrackNativeRuntime_la_LDFLAGS = -version-info 1:0:1 @CWD_LIBS@

rtlibdir = $(libdir)/crack-$(VERSION)/crack
rtlib_LTLIBRARIES = runtime.la

runtime_la_LDFLAGS = -avoid-version -module -lpthread
runtime_la_SOURCES = %libRuntimeSources%

# this is really annoying, testext needs to be installed in order to generate 
# a .so file.
extlibdir = $(libdir)/crack-$(VERSION)/crack/ext
extlib_LTLIBRARIES = test/testext.la

test_testext_la_LDFLAGS = -avoid-version -module
test_testext_la_SOURCES = test/testext.cc

if HAVE_GTK
extlib_LTLIBRARIES += _gtk.la
_gtk_la_LDFLAGS = -avoid-version -module @GTK_LIBS@ @GTK_CFLAGS@
_gtk_la_CXXFLAGS = @GTK_CFLAGS@
_gtk_la_SOURCES = opt/_gtk.cc
endif

if HAVE_PCRE
extlib_LTLIBRARIES += _pcre.la
_pcre_la_LDFLAGS = -avoid-version -module @PCRE_LIBS@ @PCRE_CFLAGS@
_pcre_la_CXXFLAGS = @PCRE_CFLAGS@
_pcre_la_SOURCES = opt/_pcre.cc
endif

if HAVE_SDL
extlib_LTLIBRARIES += _sdl.la
_sdl_la_LDFLAGS = -avoid-version -module @SDL_LIBS@
_sdl_la_CXXFLAGS = @SDL_CFLAGS@
_sdl_la_SOURCES = opt/_sdl.cc
endif

if HAVE_GL
extlib_LTLIBRARIES += _gl.la
_gl_la_LDFLAGS = -avoid-version -module @GL_LIBS@
_gl_la_CXXFLAGS = @GL_LIBS@
_gl_la_SOURCES = opt/_gl.cc
endif

if HAVE_CAIRO
extlib_LTLIBRARIES += _cairo.la
_cairo_la_LDFLAGS = -avoid-version -module @CAIRO_LIBS@
_cairo_la_CPPFLAGS = @CAIRO_CPPFLAGS@
_cairo_la_SOURCES = opt/_cairo.cc
endif

noinst_HEADERS = \
    builder/Builder.h \
    builder/BuilderOptions.h \
    builder/llvm/ArrayTypeDef.h \
    builder/llvm/BBranchPoint.h \
    builder/llvm/BBuilderContextData.h \
    builder/llvm/BCleanupFrame.h \
    builder/llvm/BFieldRef.h \
    builder/llvm/BFuncDef.h \
    builder/llvm/BFuncPtr.h \
    builder/llvm/BJitModuleDef.h \
    builder/llvm/BModuleDef.h \
    builder/llvm/BResultExpr.h \
    builder/llvm/BTypeDef.h \
    builder/llvm/Consts.h \
    builder/llvm/DebugInfo.h \
    builder/llvm/ExceptionCleanupExpr.h \
    builder/llvm/FuncBuilder.h \
    builder/llvm/FunctionTypeDef.h \
    builder/llvm/LLVMJitBuilder.h \
    builder/llvm/LLVMLinkerBuilder.h \
    builder/llvm/LLVMValueExpr.h \
    builder/llvm/Incompletes.h \
    builder/llvm/LLVMBuilder.h \
    builder/llvm/Native.h \
    builder/llvm/Ops.h \
    builder/llvm/PlaceholderInstruction.h \
    builder/llvm/VTableBuilder.h \
    builder/llvm/Utils.h \
    builder/llvm/VarDefs.h \
    debug/DebugTools.h \
    ext/Stub.h \
    model/AllocExpr.h \
    model/Annotation.h \
    model/ArgDef.h \
    model/AssignExpr.h \
    model/Branchpoint.h \
    model/BuilderContextData.h \
    model/CleanupFrame.h \
    model/CompositeNamespace.h \
    model/Construct.h \
    model/ConstSequenceExpr.h \
    model/ConstVarDef.h \
    model/Context.h \
    model/Expr.h \
    model/FloatConst.h \
    model/FuncAnnotation.h \
    model/FuncCall.h \
    model/FuncDef.h \
    model/Generic.h \
    model/GenericParm.h \
    model/GetRegisterExpr.h \
    model/GlobalNamespace.h \
    model/Initializers.h \
    model/InstVarDef.h \
    model/IntConst.h \
    model/LocalNamespace.h \
    model/ModuleDef.h \
    model/MultiExpr.h \
    model/Namespace.h \
    model/NullConst.h \
    model/OverloadDef.h \
    model/PrimFuncAnnotation.h \
    model/ResultExpr.h \
    model/SetRegisterExpr.h \
    model/StrConst.h \
    model/StubDef.h \
    model/TernaryExpr.h \
    model/TypeDef.h \
    model/VarAnnotation.h \
    model/VarDef.h \
    model/VarDefImpl.h \
    model/VarRef.h \
    parser/Location.h \
    parser/LocationMap.h \
    parser/ParseError.h \
    parser/Parser.h \
    parser/Token.h \
    parser/Toker.h \
    runtime/BorrowedExceptions.h \
    runtime/Dir.h \
    runtime/Exceptions.h \
    runtime/ItaniumExceptionABI.h \
    runtime/Math.h \
    runtime/Net.h \
    runtime/Process.h \
    runtime/Util.h \
    spug/Exception.h \
    spug/RCBase.h \
    spug/RCPtr.h \
    spug/StringFmt.h \
    spug/TypeInfo.h \
    compiler/init.h \
    Crack.h

compilerincdir = $(includedir)/crack-$(VERSION)/crack/compiler
compilerinc_HEADERS = \
    compiler/Annotation.h \
    compiler/CrackContext.h \
    compiler/Location.h \
    compiler/Token.h

extincdir = $(includedir)/crack-$(VERSION)/crack/ext
extinc_HEADERS = \
    ext/Func.h \
    ext/Module.h \
    ext/Object.h \
    ext/RCObj.h \
    ext/Type.h \
    ext/Var.h \
    ext/crack_config.h

EXTRA_DIST = doc lib test Credits CMakeLists.txt opt/CMakeLists.txt \
    sourceModules.txt runtimeModules.txt cmake COPYING COPYING.Lesser

bin_PROGRAMS = crack

crack_SOURCES = crack.cc
crack_LDADD = libCrackLang.la $(LDFLAGS)

# install under prefix/lib instead of libdir so it's not platform dependent.
cracklib = ${prefix}/lib/crack-${VERSION}
AM_CPPFLAGS = @LLVM_CPPFLAGS@ -DCRACKLIB=\"${cracklib}\"

TESTS = test/run_all_tests

doc/Manual.html: doc/Manual.nml doc/Manual.template
	@if which nml2html >/dev/null; then \
	   if test -e "$@" -a ! -w $@; then \
	       echo "Not generating $@: access denied."; \
	   else \
               echo generating $@; \
               nml2html -t doc/Manual.template doc/Manual.nml; \
           fi; \
	else \
	   echo "To regenerate the manual, you need the nml2html tool and "; \
	   echo "the spug libraries."; \
	fi

install-data-local: doc/Manual.html
	$(MKDIR_P) $(DESTDIR)$(cracklib)
	$(MKDIR_P) $(DESTDIR)$(cracklib)/crack
	(cd $(srcdir)/lib; \
	 for file in $$(find); do \
	   if test -d $$file; then \
	       $(MKDIR_P) $(DESTDIR)$(cracklib)/$$file; \
	   else \
	       $(INSTALL) $$file $(DESTDIR)$(cracklib)/$$file; \
	   fi; \
	 done)
	$(MKDIR_P) $(DESTDIR)$(docdir)
	$(INSTALL) $(srcdir)/doc/Manual.html $(DESTDIR)$(docdir)

install-exec-local: install-binPROGRAMS
	ln -f $(DESTDIR)$(bindir)/crack $(DESTDIR)$(bindir)/crack-$(VERSION)
	ln -sf $(DESTDIR)$(bindir)/crack-$(VERSION) $(DESTDIR)$(bindir)/crackc

uninstall-local:
	rm -r $(DESTDIR)$(cracklib)
	rm -r $(DESTDIR)$(docdir)
	rm $(DESTDIR)$(bindir)/crack-$(VERSION)

clean-local:
	rm -f lib/crack/ext/_pcre.so lib/crack/runtime.so lib/testext.so
